# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Watchtower Change Freeze Check â€” Azure DevOps Pipeline Snippet
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
# SETUP INSTRUCTIONS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. Start your Cloudflare Tunnel to expose the local Watchtower backend:
#
#      cloudflared tunnel run watchtower
#      # â†’ your backend is now reachable at https://watchtower.yourdomain.com
#
# 2. In Azure DevOps â†’ Pipelines â†’ your pipeline â†’ Edit â†’ Variables, add:
#
#      WATCHTOWER_API_URL   = https://watchtower.yourdomain.com   (not secret)
#      WATCHTOWER_API_KEY   = <value of CALENDAR_API_KEY from backend/.env>  (secret âœ“)
#
# 3. Copy the `jobs` section below into your existing azure-pipelines.yml,
#    placing the FreezeCheck job BEFORE your deploy job.
#
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Example full pipeline â€” adapt to your own trigger/jobs as needed:

trigger:
  - main

variables:
  # Override these in the Azure DevOps UI (do NOT hardcode secrets here)
  # WATCHTOWER_API_URL: (set in pipeline variables)
  # WATCHTOWER_API_KEY: (set as secret in pipeline variables)
  appName: 'PaymentAPI'

jobs:
  # â”€â”€ Job 1: Freeze-check â€” calls Watchtower API via curl â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - job: FreezeCheck
    displayName: 'ğŸ”’ Watchtower Change Freeze Check'
    pool: Default                           # â† self-hosted runner in the Default pool
    steps:
      # Calls the Watchtower freeze-check endpoint via curl.
      # The step FAILS (and blocks the pipeline) if:
      #   â€¢ the HTTP response is not 2xx, OR
      #   â€¢ the response body contains  "frozen": true
      - script: |
          set -e
          RESPONSE=$(curl -sf \
            -H "X-API-Key: $(WATCHTOWER_API_KEY)" \
            -H "Accept: application/json" \
            "$(WATCHTOWER_API_URL)/api/calendar/freeze-check")

          echo "Freeze-check response: $RESPONSE"

          FROZEN=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin)['frozen'])")

          if [ "$FROZEN" = "True" ]; then
            echo "##[error]âŒ Change freeze is active. Deployment blocked."
            exit 1
          fi

          echo "âœ… No active freeze. Proceeding with deployment."
        displayName: 'Call freeze-check endpoint'

  # â”€â”€ Job 2: Deploy â€” only runs when FreezeCheck succeeds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - job: Deploy
    displayName: 'Deploy $(appName)'
    dependsOn: FreezeCheck
    condition: succeeded()
    pool: Default                           # â† self-hosted runner in the Default pool
    steps:
      - script: |
          echo "ğŸš€ Deploying $(appName)..."
          # Replace this with your actual deployment task, e.g.:
          # - task: AzureWebApp@1
          # - task: KubernetesManifest@1
          # - script: helm upgrade ...
          echo "âœ… Deployment complete."
        displayName: 'Deploy $(appName)'
